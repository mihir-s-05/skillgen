name: Release on Push

on:
  push:
    branches: [main]

permissions:
  contents: write

jobs:
  release:
    if: "!contains(github.event.head_commit.message, 'chore: bump version')"
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Detect code changes
        id: changes
        run: |
          BEFORE="${{ github.event.before }}"
          AFTER="${{ github.sha }}"
          if [ -z "$BEFORE" ] || [ "$BEFORE" = "0000000000000000000000000000000000000000" ]; then
            RANGE="HEAD~1..HEAD"
          else
            RANGE="$BEFORE..$AFTER"
          fi
          CHANGED="$(git diff --name-only $RANGE)"
          echo "$CHANGED"
          if echo "$CHANGED" | grep -E '^(skillgen/)' >/dev/null; then
            echo "code_changed=true" >> "$GITHUB_OUTPUT"
          else
            echo "code_changed=false" >> "$GITHUB_OUTPUT"
          fi
          if echo "$CHANGED" | grep -E '^pyproject.toml$' >/dev/null; then
            echo "version_changed=true" >> "$GITHUB_OUTPUT"
          else
            echo "version_changed=false" >> "$GITHUB_OUTPUT"
          fi

      - name: Bump patch version
        if: steps.changes.outputs.code_changed == 'true' && steps.changes.outputs.version_changed != 'true'
        id: bump
        run: |
          python - <<'PY'
          import os
          import re
          from pathlib import Path

          path = Path("pyproject.toml")
          text = path.read_text(encoding="utf-8")
          match = re.search(r'(?m)^version\\s*=\\s*"(\\d+)\\.(\\d+)\\.(\\d+)"\\s*$', text)
          if not match:
            raise SystemExit("version not found in pyproject.toml")
          major, minor, patch = map(int, match.groups())
          patch += 1
          new_version = f"{major}.{minor}.{patch}"
          updated = text[:match.start()] + f'version = "{new_version}"' + text[match.end():]
          path.write_text(updated, encoding="utf-8")
          with open(os.environ["GITHUB_OUTPUT"], "a", encoding="utf-8") as f:
            f.write(f"new_version={new_version}\n")
          PY

      - name: Commit version bump
        if: steps.changes.outputs.code_changed == 'true' && steps.changes.outputs.version_changed != 'true'
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
          git add pyproject.toml
          git commit -m "chore: bump version to v${{ steps.bump.outputs.new_version }}"
          git push origin HEAD:main

      - name: Read version
        id: version
        run: |
          python - <<'PY'
          import os
          import tomllib
          from pathlib import Path

          data = tomllib.loads(Path("pyproject.toml").read_text(encoding="utf-8"))
          version = data["project"]["version"]
          with open(os.environ["GITHUB_OUTPUT"], "a", encoding="utf-8") as f:
              f.write(f"version={version}\n")
          PY

      - name: Check tag
        id: tag
        run: |
          git fetch --tags
          TAG="v${{ steps.version.outputs.version }}"
          if git rev-parse "$TAG" >/dev/null 2>&1; then
            echo "exists=true" >> "$GITHUB_OUTPUT"
          else
            echo "exists=false" >> "$GITHUB_OUTPUT"
          fi

      - name: Create GitHub release
        if: steps.tag.outputs.exists != 'true'
        uses: softprops/action-gh-release@v2
        with:
          tag_name: v${{ steps.version.outputs.version }}
          name: v${{ steps.version.outputs.version }}
          target_commitish: main
          generate_release_notes: true
